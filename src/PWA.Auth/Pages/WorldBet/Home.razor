@page "/worldbet"
@layout WorldBetLayout
@using dto.worldbet.Models
@using dto.worldbet.Enums
@using MudBlazor
@inject ITournamentService TournamentService
@inject IPronosticService PronosticService

<PageTitle>WorldBet - Accueil</PageTitle>

<div class="worldbet-home">
    <div class="hero-section text-center mb-5">
        <h1 class="display-4">🏆 Bienvenue sur WorldBet</h1>
        <p class="lead">Pronostiquez et gagnez !</p>
    </div>

    <!-- Prochains matches - Carousel -->
    <div class="section mb-5">
        <div class="section-header">
            <MudText Typo="Typo.h4" Class="mb-2">
                <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" Class="me-2" />
                Prochains Matches
            </MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                Faites vos pronostics avant le verrouillage
            </MudText>
        </div>

        @if (isLoadingUpcoming)
        {
            <div class="text-center py-5">
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                <MudText Typo="Typo.body1" Class="mt-2">Chargement...</MudText>
            </div>
        }
        else if (!upcomingMatches.Any())
        {
            <MudAlert Severity="Severity.Info" Icon="@Icons.Material.Filled.Info">
                Aucun match à venir pour le moment
            </MudAlert>
        }
        else
        {
            <div class="carousel-container">
                <MudCarousel @ref="carousel"
                             Class="carousel-custom" 
                             Style="height: auto; min-height: 500px;"
                             ShowArrows="@(upcomingMatches.Count > 1)" 
                             ShowBullets="@(upcomingMatches.Count > 1)"
                             EnableSwipeGesture="true"
                             AutoCycle="true"
                             AutoCycleTime="TimeSpan.FromSeconds(7)"
                             TData="object"
                             SelectedIndex="@selectedIndex"
                             SelectedIndexChanged="@((int newIndex) => selectedIndex = newIndex)">
                    @foreach (var match in upcomingMatches)
                    {
                        var hasProno = userPronostics.TryGetValue(match.MatchId, out var prono);
                        
                        <MudCarouselItem Transition="Transition.Slide" Class="carousel-item-custom">
                            <div class="d-flex justify-center align-center" style="width: 100%; min-height: 500px;">
                                <div class="carousel-card-wrapper">
                                    <MatchCard Match="@match" 
                                               HasPronostic="@hasProno" 
                                               UserPronostic="@prono"
                                               OnPronosticSaved="@HandlePronosticSaved" />
                                </div>
                            </div>
                        </MudCarouselItem>
                    }
                </MudCarousel>
            </div>
        }
    </div>

    <!-- Derniers résultats -->
    <div class="section mb-5">
        <div class="section-header">
            <MudText Typo="Typo.h4" Class="mb-2">
                <MudIcon Icon="@Icons.Material.Filled.EmojiEvents" Class="me-2" />
                Derniers Résultats
            </MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                Les matches récemment terminés
            </MudText>
        </div>

        @if (isLoadingRecent)
        {
            <div class="text-center py-5">
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                <MudText Typo="Typo.body1" Class="mt-2">Chargement...</MudText>
            </div>
        }
        else if (!recentMatches.Any())
        {
            <MudAlert Severity="Severity.Info" Icon="@Icons.Material.Filled.Info">
                Aucun résultat disponible
            </MudAlert>
        }
        else
        {
            <MudGrid>
                @foreach (var match in recentMatches)
                {
                    var hasProno = userPronostics.TryGetValue(match.MatchId, out var prono);
                    
                    <MudItem xs="12" md="6">
                        <MatchCard Match="@match" 
                                   HasPronostic="@hasProno" 
                                   UserPronostic="@prono"
                                   OnPronosticSaved="@HandlePronosticSaved" />
                    </MudItem>
                }
            </MudGrid>
        }
    </div>

    <!-- Quick Stats -->
    <MudGrid Class="mt-5">
        <MudItem xs="12" md="4">
            <MudPaper Elevation="2" Class="stat-card pa-4">
                <div class="d-flex align-center">
                    <div class="stat-icon me-4">
                        <MudIcon Icon="@Icons.Material.Filled.Bolt" Size="Size.Large" />
                    </div>
                    <div>
                        <MudText Typo="Typo.h4" Class="mb-0">@userPronostics.Count</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Pronostics actifs</MudText>
                    </div>
                </div>
            </MudPaper>
        </MudItem>
        
        <MudItem xs="12" md="4">
            <MudPaper Elevation="2" Class="stat-card pa-4">
                <div class="d-flex align-center">
                    <div class="stat-icon me-4">
                        <MudIcon Icon="@Icons.Material.Filled.CalendarMonth" Size="Size.Large" />
                    </div>
                    <div>
                        <MudText Typo="Typo.h4" Class="mb-0">@upcomingMatches.Count</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Matches à venir</MudText>
                    </div>
                </div>
            </MudPaper>
        </MudItem>
        
        <MudItem xs="12" md="4">
            <MudPaper Elevation="2" Class="stat-card pa-4">
                <div class="d-flex align-center">
                    <div class="stat-icon me-4">
                        <MudIcon Icon="@Icons.Material.Filled.EmojiEvents" Size="Size.Large" />
                    </div>
                    <div>
                        <MudText Typo="Typo.h4" Class="mb-0">@recentMatches.Count</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Résultats récents</MudText>
                    </div>
                </div>
            </MudPaper>
        </MudItem>
    </MudGrid>
</div>

@code {
    private MudCarousel<object>? carousel;
    private int selectedIndex = 0;
    
    private List<MatchDto> upcomingMatches = new();
    private List<MatchDto> recentMatches = new();
    private Dictionary<int, PronosticDto> userPronostics = new();

    private bool isLoadingUpcoming = true;
    private bool isLoadingRecent = true;

    protected override async Task OnInitializedAsync()
    {
        await Task.WhenAll(
            LoadUpcomingMatches(),
            LoadRecentMatches(),
            LoadPronostics()
        );
    }

    private async Task LoadUpcomingMatches()
    {
        isLoadingUpcoming = true;
        try
        {
            upcomingMatches = await TournamentService.GetUpcomingMatchesAsync(10);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading upcoming matches: {ex.Message}");
            upcomingMatches = new();
        }
        finally
        {
            isLoadingUpcoming = false;
        }
    }

    private async Task LoadRecentMatches()
    {
        isLoadingRecent = true;
        try
        {
            recentMatches = await TournamentService.GetRecentMatchesAsync(6);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading recent matches: {ex.Message}");
            recentMatches = new();
        }
        finally
        {
            isLoadingRecent = false;
        }
    }

    private async Task LoadPronostics()
    {
        try
        {
            var pronostics = await PronosticService.GetMyPronosticsAsync();
            userPronostics = pronostics.ToDictionary(p => p.MatchId, p => p);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading pronostics: {ex.Message}");
            userPronostics = new();
        }
    }

    private async Task HandlePronosticSaved(PronosticDto prono)
    {
        userPronostics[prono.MatchId] = prono;
        await InvokeAsync(StateHasChanged);
    }
}

<style>
    .worldbet-home {
        padding: 2rem 0;
    }

    .hero-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 3rem 2rem;
        border-radius: 16px;
        margin-bottom: 3rem;
        box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }

    .hero-section h1 {
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .hero-section .lead {
        color: rgba(255, 255, 255, 0.9);
    }

    .section {
        margin-bottom: 3rem;
    }

    .section-header {
        margin-bottom: 1.5rem;
    }

    /* Carousel Container */
    .carousel-container {
        max-width: 100%;
        overflow: hidden;
    }

    /* Carousel Customization */
    .carousel-custom {
        border-radius: 12px;
    }

    .carousel-item-custom {
        padding: 1rem 0;
    }

    .carousel-card-wrapper {
        max-width: 600px;
        width: 100%;
        padding: 0 1rem;
    }

    /* Stats Cards */
    .stat-card {
        border-radius: 12px;
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: default;
        height: 100%;
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.15) !important;
    }

    .stat-icon {
        width: 70px;
        height: 70px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        border-radius: 12px;
        flex-shrink: 0;
    }

    /* MudCarousel custom styles */
    ::deep .carousel-custom .mud-carousel-elements {
        height: 100% !important;
    }

    ::deep .carousel-custom .mud-carousel-item {
        height: auto !important;
        min-height: 500px;
    }

    ::deep .carousel-custom .mud-button-root {
        background-color: rgba(102, 126, 234, 0.8) !important;
        color: white !important;
    }

    ::deep .carousel-custom .mud-button-root:hover {
        background-color: rgba(102, 126, 234, 1) !important;
    }

    ::deep .carousel-custom .mud-carousel-bullets .mud-button-root {
        background-color: rgba(102, 126, 234, 0.4) !important;
        width: 12px;
        height: 12px;
        min-width: 12px;
        min-height: 12px;
        padding: 0;
        margin: 0 4px;
    }

    ::deep .carousel-custom .mud-carousel-bullets .mud-selected {
        background-color: rgba(102, 126, 234, 1) !important;
    }

    /* Mobile Responsive */
    @@media (max-width: 960px) {
        .carousel-card-wrapper {
            max-width: 100%;
            padding: 0 0.5rem;
        }
    }

    @@media (max-width: 600px) {
        .worldbet-home {
            padding: 1rem 0;
        }

        .hero-section {
            padding: 2rem 1rem;
        }

        .hero-section h1 {
            font-size: 2rem;
        }

        .carousel-card-wrapper {
            padding: 0 0.25rem;
        }

        ::deep .carousel-custom .mud-carousel-item {
            min-height: 550px;
        }

        .stat-card .d-flex {
            flex-direction: column;
            text-align: center;
        }

        .stat-icon {
            margin: 0 auto 0.5rem auto !important;
        }
    }
</style>