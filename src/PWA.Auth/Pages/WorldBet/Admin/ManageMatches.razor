@page "/worldbet/admin/matches"
@* Components/worldbet/MatchForm/MatchForm.razor *@
@using PWA.Auth.Pages.WorldBet.Shared
@using PWA.Auth.Components.worldbet
@using dto.worldbet.Models
@using dto.worldbet.Requests
@using dto.worldbet.Enums
@layout WorldBetLayout
@attribute [Authorize(Roles = "Admin,SuperAdmin")]
@inject ITournamentService TournamentService
@inject NavigationManager Navigation

<PageTitle>G√©rer les Matches</PageTitle>

<div class="manage-matches">
    <div class="page-header">
        <h3>üìã G√©rer les Matches</h3>
        <button class="btn btn-primary" @onclick="ShowCreateModal">
            <i class="bi bi-plus-circle"></i> Cr√©er un Match
        </button>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @successMessage
            <button type="button" class="btn-close" @onclick="() => successMessage = null"></button>
        </div>
    }

    <!-- Filtres -->
<div class="filters mb-4">
    <div class="row g-3">
        <div class="col-md-3">
            <select @bind="filterPhase" @bind:after="FilterMatches" class="form-select">
                <option value="">Toutes les phases</option>
                @foreach (var phase in allPhases)
                {
                    <option value="@phase.Name">@phase.Name</option>
                }
            </select>
        </div>
        <div class="col-md-3">
            <select @bind="filterGroup" @bind:after="FilterMatches" class="form-select">
                <option value="">Tous les groupes</option>
                @foreach (var group in availableGroups)
                {
                    <option value="@group">Groupe @group</option>
                }
            </select>
        </div>
            <div class="col-md-3">
                <select @bind="filterStatus" @bind:after="FilterMatches" class="form-select">
                    <option value="">Tous les statuts</option>
                    <option value="Scheduled">Programm√©</option>
                    <option value="Live">En cours</option>
                    <option value="Finished">Termin√©</option>
                    <option value="Postponed">Report√©</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Liste des matches -->
    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary"></div>
            <p class="mt-2">Chargement...</p>
        </div>
    }
    else if (!filteredMatches.Any())
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> Aucun match trouv√© avec ces crit√®res.
        </div>
    }
    else
    {
        <div class="matches-table">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Phase</th>
                        <th>Groupe</th>
                        <th>Match</th>
                        <th>Score</th>
                        <th>Statut</th>
                        <th>Lieu</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var match in filteredMatches)
                    {
                        <tr>
                            <td>@match.ScheduledDate.ToString("dd/MM/yyyy HH:mm")</td>
                            <td>@match.PhaseName</td>
                            <td>
                                @if (!string.IsNullOrEmpty(match.GroupLetter))
                                {
                                    <span class="badge bg-secondary">@match.GroupLetter</span>
                                }
                            </td>
                            <td>
                                <strong>@match.Team1Name</strong> vs <strong>@match.Team2Name</strong>
                            </td>
                            <td>
                                @if (match.ScoreTeam1.HasValue && match.ScoreTeam2.HasValue)
                                {
                                    <span class="score">@match.ScoreTeam1 - @match.ScoreTeam2</span>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td>
                                <span class="badge bg-@GetStatusColor(match.Status)">
                                    @GetStatusLabel(match.Status)
                                </span>
                            </td>
                            <td>@match.Venue</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" 
                                            @onclick="() => EditMatch(match)"
                                            title="Modifier">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" 
                                            @onclick="() => ConfirmDelete(match)"
                                            title="Supprimer">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

<!-- Modal Cr√©er/√âditer Match -->
@if (showModal)
{
    <div class="modal-backdrop show"></div>
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        @(isEditMode ? "Modifier le Match" : "Cr√©er un Match")
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body">
                    <MatchForm Model="@currentRequest"
                               Teams="@allTeams"
                               Phases="@allPhases"
                               IsLoading="@isSaving"
                               ErrorMessage="@modalError"
                               OnSubmit="SaveMatch" />
                </div>
                <div class="modal-footer">
                    <button type="button" 
                            class="btn btn-secondary" 
                            @onclick="CloseModal"
                            disabled="@isSaving">
                        Annuler
                    </button>
                    <button type="submit" 
                            class="btn btn-primary" 
                            @onclick="SaveMatch"
                            disabled="@isSaving">
                        @if (isSaving)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        @(isEditMode ? "Modifier" : "Cr√©er")
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Modal Confirmation Suppression -->
@if (showDeleteConfirm)
{
    <div class="modal-backdrop show"></div>
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmer la suppression</h5>
                    <button type="button" class="btn-close" @onclick="CancelDelete"></button>
                </div>
                <div class="modal-body">
                    @if (matchToDelete != null)
                    {
                        <p>√ätes-vous s√ªr de vouloir supprimer ce match ?</p>
                        <p class="fw-bold">
                            @matchToDelete.Team1Name vs @matchToDelete.Team2Name
                            <br />
                            <small class="text-muted">@matchToDelete.ScheduledDate.ToString("dd/MM/yyyy HH:mm")</small>
                        </p>
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            Cette action est irr√©versible.
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" 
                            class="btn btn-secondary" 
                            @onclick="CancelDelete"
                            disabled="@isDeleting">
                        Annuler
                    </button>
                    <button type="button" 
                            class="btn btn-danger" 
                            @onclick="DeleteMatchConfirmed"
                            disabled="@isDeleting">
                        @if (isDeleting)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        Supprimer
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    // Data
    private List<MatchDto> allMatches = new();
    private List<MatchDto> filteredMatches = new();
    private List<TeamDto> allTeams = new();
    private List<PhaseDto> allPhases = new();
    private List<string> availableGroups = new();
    
    // Loading states
    private bool isLoading = true;
    private bool isSaving = false;
    private bool isDeleting = false;
    
    // Filters
    private string filterPhase = "";
    private string filterGroup = "";
    private string filterStatus = "";
    
    // Modal states
    private bool showModal = false;
    private bool showDeleteConfirm = false;
    private bool isEditMode = false;
    
    // Current data
    private CreateMatchRequest currentRequest = new();
    private int currentMatchId = 0;
    private MatchDto? matchToDelete = null;
    
    // Messages
    private string? errorMessage;
    private string? successMessage;
    private string? modalError;
    
    protected override async Task OnInitializedAsync()
    {
        await LoadAllData();
    }
    
    private async Task LoadAllData()
    {
        isLoading = true;
        try
        {
            var matchesTask = TournamentService.GetAllMatchesAsync();
            var teamsTask = TournamentService.GetAllTeamsAsync();
            var phasesTask = TournamentService.GetAllPhasesAsync();
            
            await Task.WhenAll(matchesTask, teamsTask, phasesTask);
            
            allMatches = await matchesTask;
            allTeams = await teamsTask;
            allPhases = await phasesTask;

            // ? Extract unique groups from matches
            availableGroups = allMatches
                .Where(m => !string.IsNullOrEmpty(m.GroupLetter))
                .Select(m => m.GroupLetter!)
                .Distinct()
                .OrderBy(g => g)
                .ToList();
            
            FilterMatches();
            
            FilterMatches();
        }
        catch (Exception ex)
        {
            errorMessage = $"Erreur lors du chargement des donn√©es : {ex.Message}";
            Console.WriteLine($"Error: {ex}");
        }
        finally
        {
            isLoading = false;
        }
    }
    
    private void FilterMatches()
    {
        filteredMatches = allMatches.Where(m =>
            (string.IsNullOrEmpty(filterPhase) || m.PhaseName.Contains(filterPhase)) &&
            (string.IsNullOrEmpty(filterGroup) || m.GroupLetter == filterGroup) &&
            (string.IsNullOrEmpty(filterStatus) || m.Status.ToString() == filterStatus)
        ).OrderBy(m => m.ScheduledDate).ToList();
    }
    
    private void ShowCreateModal()
    {
        currentRequest = new CreateMatchRequest
        {
            ScheduledDate = DateTime.Now.AddDays(1),
            LockPronosticsAt = DateTime.Now.AddDays(1).AddMinutes(-5),
            Status = MatchStatus.Scheduled
        };
        currentMatchId = 0;
        isEditMode = false;
        modalError = null;
        showModal = true;
    }
    
    private void EditMatch(MatchDto match)
    {
        currentRequest = new CreateMatchRequest
        {
            PhaseId = match.PhaseId,
            Team1Id = match.Team1Id,
            Team2Id = match.Team2Id,
            ScheduledDate = match.ScheduledDate,
            Venue = match.Venue,
            MatchNumber = match.MatchNumber,
            GroupLetter = match.GroupLetter,
            ScoreTeam1 = match.ScoreTeam1,
            ScoreTeam2 = match.ScoreTeam2,
            Status = match.Status,
            LockPronosticsAt = match.LockPronosticsAt
        };
        currentMatchId = match.MatchId;
        isEditMode = true;
        modalError = null;
        showModal = true;
    }
    
    private async Task SaveMatch()
    {
        isSaving = true;
        modalError = null;
        
        try
        {
            if (isEditMode)
            {
                var updateRequest = new UpdateMatchRequest
                {
                    PhaseId = currentRequest.PhaseId,
                    Team1Id = currentRequest.Team1Id,
                    Team2Id = currentRequest.Team2Id,
                    ScheduledDate = currentRequest.ScheduledDate,
                    Venue = currentRequest.Venue,
                    MatchNumber = currentRequest.MatchNumber,
                    GroupLetter = currentRequest.GroupLetter,
                    ScoreTeam1 = currentRequest.ScoreTeam1,
                    ScoreTeam2 = currentRequest.ScoreTeam2,
                    Status = currentRequest.Status,
                    LockPronosticsAt = currentRequest.LockPronosticsAt
                };
                
                await TournamentService.UpdateMatchAsync(currentMatchId, updateRequest);
                successMessage = "Match modifi√© avec succ√®s !";
            }
            else
            {
                await TournamentService.CreateMatchAsync(currentRequest);
                successMessage = "Match cr√©√© avec succ√®s !";
            }
            
            await LoadAllData();
            CloseModal();
        }
        catch (Exception ex)
        {
            modalError = $"Erreur : {ex.Message}";
            Console.WriteLine($"Error saving match: {ex}");
        }
        finally
        {
            isSaving = false;
        }
    }
    
    private void ConfirmDelete(MatchDto match)
    {
        matchToDelete = match;
        showDeleteConfirm = true;
    }
    
    private void CancelDelete()
    {
        matchToDelete = null;
        showDeleteConfirm = false;
    }
    
    private async Task DeleteMatchConfirmed()
    {
        if (matchToDelete == null) return;
        
        isDeleting = true;
        try
        {
            var success = await TournamentService.DeleteMatchAsync(matchToDelete.MatchId);
            
            if (success)
            {
                successMessage = "Match supprim√© avec succ√®s !";
                await LoadAllData();
            }
            else
            {
                errorMessage = "Match introuvable.";
            }
            
            CancelDelete();
        }
        catch (InvalidOperationException ex)
        {
            errorMessage = ex.Message;
            CancelDelete();
        }
        catch (Exception ex)
        {
            errorMessage = $"Erreur lors de la suppression : {ex.Message}";
            Console.WriteLine($"Error deleting match: {ex}");
            CancelDelete();
        }
        finally
        {
            isDeleting = false;
        }
    }
    
    private void CloseModal()
    {
        showModal = false;
        currentRequest = new();
        currentMatchId = 0;
        modalError = null;
    }
    
    private string GetStatusColor(MatchStatus status) => status switch
    {
        MatchStatus.Scheduled => "secondary",
        MatchStatus.Live => "success",
        MatchStatus.Finished => "primary",
        MatchStatus.Postponed => "warning",
        _ => "secondary"
    };
    
    private string GetStatusLabel(MatchStatus status) => status switch
    {
        MatchStatus.Scheduled => "Programm√©",
        MatchStatus.Live => "En cours",
        MatchStatus.Finished => "Termin√©",
        MatchStatus.Postponed => "Report√©",
        _ => status.ToString()
    };
}

<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }
    
    .matches-table {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .table {
        margin: 0;
    }
    
    .table th {
        background: #f8f9fa;
        font-weight: 600;
        border-bottom: 2px solid #dee2e6;
    }
    
    .table tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    .score {
        font-weight: bold;
        font-size: 1.1rem;
    }
    
    .modal-backdrop {
        background: rgba(0,0,0,0.5);
    }
    
    .modal {
        overflow-y: auto;
    }
</style>