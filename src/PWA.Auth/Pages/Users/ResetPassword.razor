@* Pages/ResetPassword.razor *@
@page "/reset-password"
@using dto.user.Models
@attribute [AllowAnonymous]

<PageTitle>Reset Password - MaesAuth</PageTitle>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-body p-4">
                    @if (!isTokenValid)
                    {
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle"></i>
                            <strong>Invalid or Expired Link</strong>
                            <p class="mb-0 mt-2">This password reset link is invalid or has expired. Please request a new one.</p>
                        </div>
                        <div class="text-center mt-3">
                            <a href="/forgot-password" class="btn btn-primary">
                                Request New Link
                            </a>
                        </div>
                    }
                    else if (isSuccess)
                    {
                        <div class="text-center">
                            <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                            <h2 class="mt-3">Password Reset Successfully!</h2>
                            <p class="text-muted">You can now sign in with your new password.</p>
                            <button class="btn btn-primary mt-3" @onclick="GoToLogin">
                                <i class="bi bi-box-arrow-in-right"></i> Sign In
                            </button>
                        </div>
                    }
                    else
                    {
                        <PasswordSetupForm 
                            Title="Reset Your Password"
                            Description="Enter your new password"
                            IconClass="bi bi-shield-lock"
                            SubmitButtonText="Reset Password"
                            LoadingText="Resetting..."
                            IsLoading="@isLoading"
                            IsSuccess="@isSuccess"
                            ErrorMessage="@errorMessage"
                            OnSubmit="HandlePasswordSubmit" />
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Inject] private IUserService UserService { get; set; } = default!;
    [Inject] private NavigationManager Navigation { get; set; } = default!;
    
    [SupplyParameterFromQuery(Name = "token")]
    public string? Token { get; set; }

    private bool isLoading = false;
    private bool isSuccess = false;
    private bool isTokenValid = true;
    private string? errorMessage;

    protected override void OnInitialized()
    {
        if (string.IsNullOrEmpty(Token))
        {
            isTokenValid = false;
            errorMessage = "No reset token provided";
        }
    }

    private async Task HandlePasswordSubmit(PasswordSetupForm.PasswordSetupModel model)
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            var request = new ResetPasswordRequest
            {
                Token = Token!,
                Password = model.Password,
                ConfirmPassword = model.ConfirmPassword
            };

            var response = await UserService.ResetPassword(request);

            if (response.Success)
            {
                isSuccess = true;
            }
            else
            {
                errorMessage = response.ErrorMessage ?? "Failed to reset password";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void GoToLogin()
    {
        Navigation.NavigateTo("/login");
    }
}