@* Components/worldbet/MatchForm/MatchForm.razor *@
@using dto.worldbet.Models
@using dto.worldbet.Requests
@using dto.worldbet.Enums

@namespace PWA.Auth.Components.worldbet

<MudForm @ref="form" @bind-IsValid="@isValid">
    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <MudAlert Severity="Severity.Error" Class="mb-4">@ErrorMessage</MudAlert>
    }
    
    <MudGrid Spacing="3">
        <!-- Phase & Group -->
        <MudItem xs="12" md="6">
            <MudSelect T="int" 
                       @bind-Value="Model.PhaseId"
                       Label="Phase" 
                       Variant="Variant.Outlined"
                       Required="true"
                       RequiredError="La phase est requise"
                       Disabled="@IsLoading"
                       AdornmentIcon="@Icons.Material.Filled.Stadium"
                       AdornmentColor="Color.Primary">
                @foreach (var phase in Phases)
                {
                    <MudSelectItem Value="@phase.PhaseId">@phase.Name</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        
        <MudItem xs="12" md="6">
            <MudSelect T="string" 
                       @bind-Value="Model.GroupLetter"
                       Label="Groupe (optionnel)" 
                       Variant="Variant.Outlined"
                       Clearable="true"
                       Disabled="@IsLoading"
                       AdornmentIcon="@Icons.Material.Filled.Groups"
                       AdornmentColor="Color.Secondary">
                <MudSelectItem Value="@((string)null!)">Aucun groupe</MudSelectItem>
                @for (char c = 'A'; c <= 'H'; c++)
                {
                    var groupLetter = c.ToString();
                    <MudSelectItem Value="@groupLetter">Groupe @groupLetter</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        
        <!-- Teams -->
        <MudItem xs="12" md="6">
            <MudSelect T="int" 
                       @bind-Value="Model.Team1Id"
                       Label="Équipe 1" 
                       Variant="Variant.Outlined"
                       Required="true"
                       RequiredError="L'équipe 1 est requise"
                       Disabled="@IsLoading"
                       AdornmentIcon="@Icons.Material.Filled.Sports"
                       AdornmentColor="Color.Primary">
                @foreach (var team in Teams.Where(t => t.TeamId != Model.Team2Id))
                {
                    <MudSelectItem Value="@team.TeamId">@team.Name</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        
        <MudItem xs="12" md="6">
            <MudSelect T="int" 
                       @bind-Value="Model.Team2Id"
                       Label="Équipe 2" 
                       Variant="Variant.Outlined"
                       Required="true"
                       RequiredError="L'équipe 2 est requise"
                       Disabled="@IsLoading"
                       AdornmentIcon="@Icons.Material.Filled.Sports"
                       AdornmentColor="Color.Primary">
                @foreach (var team in Teams.Where(t => t.TeamId != Model.Team1Id))
                {
                    <MudSelectItem Value="@team.TeamId">@team.Name</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        
        <!-- Date & Venue -->
        <MudItem xs="12" md="6">
            <MudDatePicker @bind-Date="scheduledDate"
                           Label="Date du match"
                           Variant="Variant.Outlined"
                           Required="true"
                           RequiredError="La date est requise"
                           Disabled="@IsLoading"
                           Adornment="Adornment.Start"
                           AdornmentIcon="@Icons.Material.Filled.CalendarMonth"
                           AdornmentColor="Color.Primary"
                           DateFormat="dd/MM/yyyy"
                           @bind-Date:after="UpdateScheduledDate" />
            <MudTimePicker @bind-Time="scheduledTime"
                           Label="Heure du match"
                           Variant="Variant.Outlined"
                           Required="true"
                           Disabled="@IsLoading"
                           Adornment="Adornment.Start"
                           AdornmentIcon="@Icons.Material.Filled.AccessTime"
                           AdornmentColor="Color.Primary"
                           AmPm="false"
                           @bind-Time:after="UpdateScheduledDate"
                           Class="mt-2" />
        </MudItem>
        
        <MudItem xs="12" md="6">
            <MudTextField T="string" 
                          @bind-Value="Model.Venue"
                          Label="Lieu"
                          Variant="Variant.Outlined"
                          Placeholder="Ex: Stade de France, Paris"
                          Disabled="@IsLoading"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.LocationOn"
                          AdornmentColor="Color.Secondary"
                          HelperText="Nom du stade où se joue le match" />
        </MudItem>
        
        <!-- Match Number -->
        <MudItem xs="12" md="4">
            <MudNumericField T="int" 
                             @bind-Value="Model.MatchNumber"
                             Label="Numéro du match"
                             Variant="Variant.Outlined"
                             Min="0"
                             Placeholder="1, 2, 3..."
                             Disabled="@IsLoading"
                             Adornment="Adornment.Start"
                             AdornmentIcon="@Icons.Material.Filled.Numbers"
                             HelperText="Numéro séquentiel du match (0 = auto)" />
        </MudItem>
        
        <!-- Scores -->
        <MudItem xs="12" md="4">
            <MudNumericField T="int?" 
                             @bind-Value="Model.ScoreTeam1"
                             Label="Score Équipe 1"
                             Variant="Variant.Outlined"
                             Min="0"
                             Max="20"
                             Disabled="@IsLoading"
                             Adornment="Adornment.Start"
                             AdornmentIcon="@Icons.Material.Filled.SportsScore"
                             HelperText="Laisser vide si pas encore joué" />
        </MudItem>
        
        <MudItem xs="12" md="4">
            <MudNumericField T="int?" 
                             @bind-Value="Model.ScoreTeam2"
                             Label="Score Équipe 2"
                             Variant="Variant.Outlined"
                             Min="0"
                             Max="20"
                             Disabled="@IsLoading"
                             Adornment="Adornment.Start"
                             AdornmentIcon="@Icons.Material.Filled.SportsScore"
                             HelperText="Laisser vide si pas encore joué" />
        </MudItem>
        
        <!-- Status -->
        <MudItem xs="12" md="6">
            <MudSelect T="MatchStatus" 
                       @bind-Value="Model.Status"
                       Label="Statut" 
                       Variant="Variant.Outlined"
                       Disabled="@IsLoading"
                       AdornmentIcon="@Icons.Material.Filled.Flag"
                       AdornmentColor="@GetStatusColor(Model.Status)">
                <MudSelectItem Value="@MatchStatus.Scheduled">
                    <div class="d-flex align-items-center gap-2">
                        <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" />
                        Programmé
                    </div>
                </MudSelectItem>
                <MudSelectItem Value="@MatchStatus.Live">
                    <div class="d-flex align-items-center gap-2">
                        <MudIcon Icon="@Icons.Material.Filled.PlayArrow" Size="Size.Small" Color="Color.Success" />
                        En cours
                    </div>
                </MudSelectItem>
                <MudSelectItem Value="@MatchStatus.Finished">
                    <div class="d-flex align-items-center gap-2">
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Color="Color.Primary" />
                        Terminé
                    </div>
                </MudSelectItem>
                <MudSelectItem Value="@MatchStatus.Postponed">
                    <div class="d-flex align-items-center gap-2">
                        <MudIcon Icon="@Icons.Material.Filled.EventBusy" Size="Size.Small" Color="Color.Warning" />
                        Reporté
                    </div>
                </MudSelectItem>
            </MudSelect>
        </MudItem>
        
        <!-- Lock Pronostics -->
        <MudItem xs="12" md="6">
            <MudDatePicker @bind-Date="lockDate"
                           Label="Date de verrouillage"
                           Variant="Variant.Outlined"
                           Disabled="@IsLoading"
                           Adornment="Adornment.Start"
                           AdornmentIcon="@Icons.Material.Filled.Lock"
                           AdornmentColor="Color.Warning"
                           DateFormat="dd/MM/yyyy"
                           @bind-Date:after="UpdateLockDateTime" />
            <MudTimePicker @bind-Time="lockTime"
                           Label="Heure de verrouillage"
                           Variant="Variant.Outlined"
                           Disabled="@IsLoading"
                           Adornment="Adornment.Start"
                           AdornmentIcon="@Icons.Material.Filled.Lock"
                           AdornmentColor="Color.Warning"
                           AmPm="false"
                           @bind-Time:after="UpdateLockDateTime"
                           Class="mt-2">
                <HelperContent>
                    <MudText Typo="Typo.caption" Color="Color.Warning">
                        <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" />
                        Automatiquement défini à 5 min avant le match
                    </MudText>
                </HelperContent>
            </MudTimePicker>
        </MudItem>
        
        <!-- Submit Button -->
        <MudItem xs="12" Class="d-flex justify-content-end gap-2">
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Primary" 
                       StartIcon="@Icons.Material.Filled.Save"
                       Disabled="@(!isValid || IsLoading)"
                       OnClick="@HandleSubmit"
                       Size="Size.Large">
                @if (IsLoading)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="me-2" />
                }
                Enregistrer
            </MudButton>
        </MudItem>
    </MudGrid>
</MudForm>

@code {
    [Parameter] public CreateMatchRequest Model { get; set; } = new();
    [Parameter] public List<TeamDto> Teams { get; set; } = new();
    [Parameter] public List<PhaseDto> Phases { get; set; } = new();
    [Parameter] public bool IsLoading { get; set; }
    [Parameter] public string? ErrorMessage { get; set; }
    [Parameter] public EventCallback OnSubmit { get; set; }

    private MudForm? form;
    private bool isValid;

    // Date/Time helpers for MudBlazor pickers
    private DateTime? scheduledDate;
    private TimeSpan? scheduledTime;
    private DateTime? lockDate;
    private TimeSpan? lockTime;

    protected override void OnParametersSet()
    {
        Console.WriteLine("MatchForm - OnParametersSet called");
        Console.WriteLine($"  Model: {Model != null}");
        Console.WriteLine($"  Teams: {Teams?.Count ?? 0} items");
        Console.WriteLine($"  Phases: {Phases?.Count ?? 0} items");
        
        // Ensure dates are valid when model is updated
        if (Model != null && Model.ScheduledDate == DateTime.MinValue)
        {
            Model.ScheduledDate = DateTime.Now.AddDays(1);
        }
        if (Model != null && Model.LockPronosticsAt == DateTime.MinValue)
        {
            Model.LockPronosticsAt = Model.ScheduledDate.AddMinutes(-5);
        }

        // Initialize date/time pickers from Model
        if (Model != null)
        {
            scheduledDate = Model.ScheduledDate.Date;
            scheduledTime = Model.ScheduledDate.TimeOfDay;
            lockDate = Model.LockPronosticsAt.Date;
            lockTime = Model.LockPronosticsAt.TimeOfDay;
        }
    }

    private async Task HandleSubmit()
    {
        if (form != null)
        {
            await form.Validate();
            if (isValid)
            {
                await OnSubmit.InvokeAsync();
            }
        }
    }

    private void UpdateScheduledDate()
    {
        if (scheduledDate.HasValue && scheduledTime.HasValue)
        {
            Model.ScheduledDate = scheduledDate.Value.Date + scheduledTime.Value;
            UpdateLockDate();
            Console.WriteLine($"UpdateScheduledDate: {Model.ScheduledDate}");
        }
    }

    private void UpdateLockDateTime()
    {
        if (lockDate.HasValue && lockTime.HasValue)
        {
            Model.LockPronosticsAt = lockDate.Value.Date + lockTime.Value;
            Console.WriteLine($"UpdateLockDateTime: {Model.LockPronosticsAt}");
        }
    }

    private void UpdateLockDate()
    {
        // Only update if ScheduledDate is valid (not default/min value)
        if (Model.ScheduledDate > DateTime.MinValue && Model.ScheduledDate < DateTime.MaxValue.AddDays(-1))
        {
            Model.LockPronosticsAt = Model.ScheduledDate.AddMinutes(-5);
            lockDate = Model.LockPronosticsAt.Date;
            lockTime = Model.LockPronosticsAt.TimeOfDay;
            Console.WriteLine($"UpdateLockDate: ScheduledDate={Model.ScheduledDate}, LockPronosticsAt={Model.LockPronosticsAt}");
        }
    }

    private Color GetStatusColor(MatchStatus status) => status switch
    {
        MatchStatus.Scheduled => Color.Default,
        MatchStatus.Live => Color.Success,
        MatchStatus.Finished => Color.Primary,
        MatchStatus.Postponed => Color.Warning,
        _ => Color.Default
    };
}