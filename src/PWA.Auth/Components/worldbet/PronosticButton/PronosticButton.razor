@* Components/WorldBet/PronosticButton/PronosticButton.razor *@
@* Version avec MudIconButton *@
@using dto.worldbet.Models
@using dto.worldbet.Enums

@if (CanPronostic())
{
    <MudTooltip Text="@(HasPronostic ? "Modifier mon pronostic" : "Pronostiquer")">
        <MudIconButton Icon="@Icons.Material.Filled.Bolt"
                       Color="@(HasPronostic ? Color.Warning : Color.Success)" 
                       Size="@GetMudSize()"
                       OnClick="@OpenModal"
                       Class="@CssClass" />
    </MudTooltip>
}
else if (Match.Status == MatchStatus.Finished)
{
    <MudTooltip Text="Match terminé">
        <MudIconButton Icon="@Icons.Material.Filled.CheckCircle"
                       Color="@Color.Default" 
                       Size="@GetMudSize()"
                       Disabled="true"
                       Class="@CssClass" />
    </MudTooltip>
}
else
{
    <MudTooltip Text="Pronostics fermés">
        <MudIconButton Icon="@Icons.Material.Filled.Lock"
                       Color="@Color.Default" 
                       Size="@GetMudSize()"
                       Disabled="true"
                       Class="@CssClass" />
    </MudTooltip>
}

<!-- Pronostic Modal -->
<PronosticModal Show="@showModal"
                Match="@Match"
                OnClose="@CloseModal"
                OnSaved="@HandlePronosticSaved" />

@code {
    [Parameter, EditorRequired] 
    public MatchDto Match { get; set; } = null!;
    
    [Parameter] 
    public bool HasPronostic { get; set; }
    
    [Parameter] 
    public EventCallback<PronosticDto> OnPronosticSaved { get; set; }
    
    [Parameter] 
    public string Size { get; set; } = "Medium"; // Small, Medium, Large
    
    [Parameter] 
    public string CssClass { get; set; } = "";

    private bool showModal = false;

    private bool CanPronostic()
    {
        return Match.Status == MatchStatus.Scheduled 
            && DateTime.UtcNow < Match.LockPronosticsAt;
    }

    private void OpenModal()
    {
        showModal = true;
    }

    private void CloseModal()
    {
        showModal = false;
    }

    private async Task HandlePronosticSaved(PronosticDto prono)
    {
        showModal = false;
        
        if (OnPronosticSaved.HasDelegate)
        {
            await OnPronosticSaved.InvokeAsync(prono);
        }
    }

    private MudBlazor.Size GetMudSize()
    {
        return Size.ToLower() switch
        {
            "small" or "sm" => MudBlazor.Size.Small,
            "large" or "lg" => MudBlazor.Size.Large,
            _ => MudBlazor.Size.Medium
        };
    }
}