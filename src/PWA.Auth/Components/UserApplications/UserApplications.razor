@* Components/UserApplications/UserApplications.razor *@
@using dto.user.Models
@inject IUserService UserService
@inject IApplicationService ApplicationService
@inject ILogger<UserApplications> Logger

<div class="user-applications">
    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle"></i> @ErrorMessage
            <button type="button" class="btn-close" @onclick="() => ErrorMessage = null"></button>
        </div>
    }

    @if (SuccessMessage != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle"></i> @SuccessMessage
            <button type="button" class="btn-close" @onclick="() => SuccessMessage = null"></button>
        </div>
    }

    <!-- Current Applications -->
    <div class="card mb-3">
        <div class="card-header bg-primary text-white">
            <h6 class="mb-0">
                <i class="bi bi-app"></i> Assigned Applications
            </h6>
        </div>
        <div class="card-body">
            @if (isLoadingAssignments)
            {
                <div class="text-center py-3">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span class="ms-2">Loading applications...</span>
                </div>
            }
            else if (!userApplications.Any())
            {
                <p class="text-muted mb-0">
                    <i class="bi bi-info-circle"></i> No applications assigned yet
                </p>
            }
            else
            {
                <div class="list-group list-group-flush">
                    @foreach (var userApp in userApplications)
                    {
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-app-indicator text-primary"></i>
                                <strong>@userApp.ApplicationName</strong>
                                <br />
                                <small class="text-muted">
                                    Assigned: @userApp.GrantedAt.ToString("yyyy-MM-dd HH:mm")
                                </small>
                            </div>
                            <button class="btn btn-sm btn-outline-danger" 
                                    @onclick="() => RemoveApplication(userApp.ApplicationId)"
                                    disabled="@isLoadingAction">
                                @if (isLoadingAction && actionApplicationId == userApp.ApplicationId)
                                {
                                    <span class="spinner-border spinner-border-sm"></span>
                                }
                                else
                                {
                                    <i class="bi bi-trash"></i>
                                }
                            </button>
                        </div>
                    }
                </div>
            }
        </div>
    </div>

    <!-- Add New Application -->
    <div class="card">
        <div class="card-header bg-success text-white">
            <h6 class="mb-0">
                <i class="bi bi-plus-circle"></i> Add Application
            </h6>
        </div>
        <div class="card-body">
            @if (isLoadingAvailable)
            {
                <div class="text-center py-3">
                    <div class="spinner-border spinner-border-sm text-success" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span class="ms-2">Loading available applications...</span>
                </div>
            }
            else if (!availableApplications.Any())
            {
                <p class="text-muted mb-0">
                    <i class="bi bi-check-circle"></i> All applications are already assigned
                </p>
            }
            else
            {
                <div class="row g-2">
                    <div class="col">
                        <select class="form-select" @bind="selectedApplicationId" disabled="@isLoadingAction">
                            <option value="0">-- Select an application --</option>
                            @foreach (var app in availableApplications)
                            {
                                <option value="@app.Id">@app.Name</option>
                            }
                        </select>
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-success" 
                                @onclick="AddApplication"
                                disabled="@(isLoadingAction || selectedApplicationId == 0)">
                            @if (isLoadingAction && selectedApplicationId != 0)
                            {
                                <span class="spinner-border spinner-border-sm me-1"></span>
                            }
                            else
                            {
                                <i class="bi bi-plus-lg me-1"></i>
                            }
                            Add
                        </button>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter] public int UserId { get; set; }
    [Parameter] public EventCallback OnApplicationsChanged { get; set; }

    private List<UserApplicationDto> userApplications = new();
    private List<ApplicationDto> availableApplications = new();
    private int selectedApplicationId = 0;
    private int actionApplicationId = 0;
    
    private bool isLoadingAssignments = false;
    private bool isLoadingAvailable = false;
    private bool isLoadingAction = false;
    
    private string? ErrorMessage;
    private string? SuccessMessage;

    protected override async Task OnParametersSetAsync()
    {
        if (UserId > 0)
        {
            await LoadUserApplications();
            await LoadAvailableApplications();
        }
    }

    private async Task LoadUserApplications()
    {
        isLoadingAssignments = true;
        ErrorMessage = null;
        
        try
        {
            var result = await UserService.GetUserApplications(UserId);
            
            if (result.Success && result.Data != null)
            {
                userApplications = result.Data;
            }
            else
            {
                ErrorMessage = result.ErrorMessage ?? "Failed to load user applications";
                Logger.LogError("Failed to load applications for user {UserId}: {Error}", 
                    UserId, result.ErrorMessage);
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = "Error loading applications";
            Logger.LogError(ex, "Error loading applications for user {UserId}", UserId);
        }
        finally
        {
            isLoadingAssignments = false;
        }
    }

    private async Task LoadAvailableApplications()
    {
        isLoadingAvailable = true;
        
        try
        {
            var result = await ApplicationService.GetAllApplications();
            
            if (result.Success && result.Data != null)
            {
                // Filter out already assigned applications
                var assignedAppIds = userApplications.Select(ua => ua.ApplicationId).ToHashSet();
                availableApplications = result.Data.Where(a => !assignedAppIds.Contains(a.Id)).ToList();
            }
            else
            {
                ErrorMessage = result.ErrorMessage ?? "Failed to load applications";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = "Error loading available applications";
            Logger.LogError(ex, "Error loading available applications");
        }
        finally
        {
            isLoadingAvailable = false;
        }
    }

    private async Task AddApplication()
    {
        if (selectedApplicationId == 0) return;

        isLoadingAction = true;
        ErrorMessage = null;
        SuccessMessage = null;

        try
        {
            var request = new AssignApplicationRequest
            {
                UserId = UserId,
                ApplicationId = selectedApplicationId
            };

            var result = await UserService.AssignApplication(request);

            if (result.Success && result.Data != null)
            {
                var appName = availableApplications.First(a => a.Id == selectedApplicationId).Name;
                SuccessMessage = $"Application '{appName}' assigned successfully";
                
                selectedApplicationId = 0;
                await LoadUserApplications();
                await LoadAvailableApplications();
                await OnApplicationsChanged.InvokeAsync();
            }
            else
            {
                ErrorMessage = result.ErrorMessage ?? "Failed to assign application";
                Logger.LogError("Failed to assign application {AppId} to user {UserId}: {Error}", 
                    selectedApplicationId, UserId, result.ErrorMessage);
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = "Error assigning application";
            Logger.LogError(ex, "Error assigning application {AppId} to user {UserId}", 
                selectedApplicationId, UserId);
        }
        finally
        {
            isLoadingAction = false;
        }
    }

    private async Task RemoveApplication(int applicationId)
    {
        var app = userApplications.FirstOrDefault(ua => ua.ApplicationId == applicationId);
        if (app == null) return;

        if (!await JSInterop.ConfirmAsync($"Remove application '{app.ApplicationName}'?"))
            return;

        isLoadingAction = true;
        actionApplicationId = applicationId;
        ErrorMessage = null;
        SuccessMessage = null;

        try
        {
            var request = new RemoveApplicationRequest
            {
                UserId = UserId,
                ApplicationId = applicationId
            };

            var result = await UserService.RemoveApplication(request);

            if (result.Success)
            {
                SuccessMessage = $"Application '{app.ApplicationName}' removed successfully";
                
                await LoadUserApplications();
                await LoadAvailableApplications();
                await OnApplicationsChanged.InvokeAsync();
            }
            else
            {
                ErrorMessage = result.ErrorMessage ?? "Failed to remove application";
                Logger.LogError("Failed to remove application {AppId} from user {UserId}: {Error}", 
                    applicationId, UserId, result.ErrorMessage);
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = "Error removing application";
            Logger.LogError(ex, "Error removing application {AppId} from user {UserId}", 
                applicationId, UserId);
        }
        finally
        {
            isLoadingAction = false;
            actionApplicationId = 0;
        }
    }
}