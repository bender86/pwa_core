@* Components/UserForm/UserForm.razor *@
@using dto.common.Enums
@using dto.user.Enums
@using dto.user.Models
@using PWA.Auth.Models

<div class="user-form">
    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle"></i> @ErrorMessage
            <button type="button" class="btn-close" @onclick="() => ErrorMessage = null"></button>
        </div>
    }

    <EditForm Model="@model" OnValidSubmit="HandleSubmit">
        <DataAnnotationsValidator />
        
        <div class="row g-3">
            <!-- Prénom -->
            <div class="col-md-6">
                <label class="form-label">First Name <span class="text-danger">*</span></label>
                <InputText @bind-Value="model.FirstName" 
                           class="form-control" 
                           placeholder="First name"
                           disabled="@IsLoading" />
                <ValidationMessage For="@(() => model.FirstName)" class="text-danger small" />
            </div>

            <!-- Nom -->
            <div class="col-md-6">
                <label class="form-label">Last Name <span class="text-danger">*</span></label>
                <InputText @bind-Value="model.LastName" 
                           class="form-control" 
                           placeholder="Last name"
                           disabled="@IsLoading" />
                <ValidationMessage For="@(() => model.LastName)" class="text-danger small" />
            </div>

            <!-- Email -->
            <div class="col-12">
                <label class="form-label">Email <span class="text-danger">*</span></label>
                <InputText @bind-Value="model.Email" 
                           type="email"
                           class="form-control" 
                           placeholder="email@example.com"
                           disabled="@(IsLoading || Mode == FormMode.Edit)" />
                <ValidationMessage For="@(() => model.Email)" class="text-danger small" />
                @if (Mode == FormMode.Create && !RequirePassword)
                {
                    <div class="form-text">
                        <i class="bi bi-info-circle"></i> An invitation email will be sent to this address
                    </div>
                }
            </div>

            <!-- Mot de passe (seulement si requis) -->
            @if (RequirePassword && Mode == FormMode.Create)
            {
                <div class="col-12">
                    <label class="form-label">Password <span class="text-danger">*</span></label>
                    <InputText type="password" 
                               @bind-Value="model.Password" 
                               class="form-control" 
                               placeholder="••••••••"
                               disabled="@IsLoading" />
                    <ValidationMessage For="@(() => model.Password)" class="text-danger small" />
                </div>
            }

            <!-- Options Admin -->
            @if (ShowAdminOptions)
            {
                <div class="col-12">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6 class="card-title mb-3">
                                <i class="bi bi-shield-lock"></i> Admin Options
                            </h6>
                            
                            <div class="form-check mb-2">
                                <InputCheckbox @bind-Value="model.IsAdmin" 
                                               class="form-check-input" 
                                               id="isAdmin"
                                               disabled="@IsLoading" />
                                <label class="form-check-label" for="isAdmin">
                                    Administrator
                                </label>
                            </div>

                            <div class="form-check">
                                <InputCheckbox @bind-Value="model.Active" 
                                               class="form-check-input" 
                                               id="isActive"
                                               disabled="@IsLoading" />
                                <label class="form-check-label" for="isActive">
                                    Active
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Boutons d'action -->
        <div class="d-flex gap-2 mt-4">
            <button type="submit" class="btn btn-primary" disabled="@IsLoading">
                @if (IsLoading)
                {
                    <span class="spinner-border spinner-border-sm me-2"></span>
                    <span>Saving...</span>
                }
                else
                {
                    <i class="bi bi-@(Mode == FormMode.Create ? "plus-lg" : "check-lg")"></i>
                    <span>@(Mode == FormMode.Create ? "Create User" : "Update")</span>
                }
            </button>

            @if (ShowCancelButton)
            {
                <button type="button" class="btn btn-outline-secondary" @onclick="OnCancel" disabled="@IsLoading">
                    <i class="bi bi-x-lg"></i> Cancel
                </button>
            }
        </div>
    </EditForm>
</div>

@code {
    [Parameter] public FormMode Mode { get; set; }
    [Parameter] public UserFormModel? InitialData { get; set; }
    [Parameter] public EventCallback<UserFormModel> OnSubmit { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public bool IsLoading { get; set; }
    [Parameter] public string? ErrorMessage { get; set; }
    [Parameter] public bool ShowAdminOptions { get; set; } = false;
    [Parameter] public bool ShowCancelButton { get; set; } = true;
    [Parameter] public bool RequirePassword { get; set; } = false; // Nouveau paramètre

    private UserFormModel model = new();

    protected override void OnParametersSet()
    {
        if (InitialData != null)
        {
            model = new UserFormModel
            {
                Id = InitialData.Id,
                FirstName = InitialData.FirstName,
                LastName = InitialData.LastName,
                Email = InitialData.Email,
                Password = InitialData.Password,
                IsAdmin = InitialData.IsAdmin,
                Active = InitialData.Active,
                MfaEnabled = InitialData.MfaEnabled
            };
        }
        else
        {
            model = new UserFormModel
            {
                Active = true // Par défaut actif
            };
        }
    }

    private async Task HandleSubmit()
    {
        await OnSubmit.InvokeAsync(model);
    }
}